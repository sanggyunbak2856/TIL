# 서블릿과 멀티쓰레드

태그: 스프링 MVC

## 서블릿

- 서블릿을 지원하는 WAS를 사용할 때
    
    ![스크린샷 2023-01-19 오후 2.29.48.png](./%EC%84%9C%EB%B8%94%EB%A6%BF%EA%B3%BC%20%EB%A9%80%ED%8B%B0%EC%93%B0%EB%A0%88%EB%93%9C/servlet.png)
    
    - tcp 소켓 연결, http 파싱, 응답 메시지 생성 등 비즈니스 로직과 관련 없는 부분을 신경쓰지 않고 개발할 수 있다.
- **특징**
    - URL이 호출되면 서블릿 코드가 실행됨
    - HTTP 요청 정보 사용 → HttpServletRequest
    - HTTP 응답 정보 사용 → HttpServletResponse
    - 개발자는 HTTP 스펙을 편리하게 사용할 수 있다
    
    ![스크린샷 2023-01-19 오후 2.32.27.png](./%EC%84%9C%EB%B8%94%EB%A6%BF%EA%B3%BC%20%EB%A9%80%ED%8B%B0%EC%93%B0%EB%A0%88%EB%93%9C/servletcontainercom.png)
    
- **HTTP 요청, 응답 흐름**
    - WAS는 Request, Response 객체를 새로 만들어서 서블릿 객체 호출
    - 개발자는 Request 객체에서 HTTP 요청 정보를 꺼내 사용
    - 개발자는 Response 객체에 HTTP 응답 정보를 입력
    - WAS는 Response 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성
- **서블릿 컨테이너**
    
    ![스크린샷 2023-01-19 오후 2.34.28.png](./%EC%84%9C%EB%B8%94%EB%A6%BF%EA%B3%BC%20%EB%A9%80%ED%8B%B0%EC%93%B0%EB%A0%88%EB%93%9C/servletcontainer.png)
    
    - 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 한다
    - 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기를 관리한다
    - 서블릿 객체는 싱글톤으로 관리
        - 요청시마다 객체를 생성하는 것은 비효율적
        - 최초 로딩 시점에 서블릿 객체를 만들어두고 재활용
        - 모든 고객 요청은 동일한 서블릿 객체 인스턴스에 접근
        - 공유 변수 사용시 주의해야함 (상태를 저장하면 안된다)
        - 서블릿 컨테이너 종료시 함께 종료됨
    - JSP도 서블릿으로 변환되어 사용된다
    - 동시 요청을 위한 멀티 쓰레드 처리 지원

## 동시 요청 - 멀티 쓰레드

- **쓰레드**
    - 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드
    - 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행
    - 쓰레드가 없다면 자바 애플리케이션 실행이 불가능
    - 쓰레드는 한번에 하나의 코드 라인만 수행
    - 동시 처리가 필요하면 쓰레드를 추가로 생성
- **요청 마다 쓰레드 생성**
    
    ![스크린샷 2023-01-19 오후 2.38.40.png](./%EC%84%9C%EB%B8%94%EB%A6%BF%EA%B3%BC%20%EB%A9%80%ED%8B%B0%EC%93%B0%EB%A0%88%EB%93%9C/requestthread.png)
    
    - 장점
        - 동시 요청을 처리할 수 있다
        - 리소스가 허용할 때 까지 처리 가능
        - 하나의 쓰레드가 지연되어도 나머지 쓰레드는 정상 동작한다
    - 단점
        - 쓰레드 생성 비용은 매우 비싸다
        - 쓰레드는 컨텍스트 스위칭 비용이 발생한다
        - 쓰레드 생성에 제한이 없다
            - 고객 요청이 너무 많으면 서버가 죽을 수 있다.
- **쓰레드 풀**
    
    ![스크린샷 2023-01-19 오후 2.40.05.png](./%EC%84%9C%EB%B8%94%EB%A6%BF%EA%B3%BC%20%EB%A9%80%ED%8B%B0%EC%93%B0%EB%A0%88%EB%93%9C/threadpool.png)
    
    - 요청 마다 쓰레드를 생성하는 것의 단점 보완
    - 특징
        - 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다
        - 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다
    - 사용
        - 쓰레드가 필요하면 쓰레드 풀에서 이미 생성되어있는 쓰레드를 꺼내 사용
        - 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납
        - 쓰레드 풀에 쓰레드가 없다면 ?
            - 기다리는 요청은 거절하거나 대기하도록 설정
    - 장점
        - 쓰레드가 미리 생성되어 있으므로 쓰레드를 생성하고 종료하는 비용이 절약되고 응답시간이 빠르다
        - 생성가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다
- **WAS의 멀티 쓰레드 지원**
    - 멀티 쓰레드에 대한 부분은 WAS가 처리함
    - 개발자는 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨
        - 싱글 쓰레드 프로그래밍을 하듯이 개발
    - 멀티 쓰레드 환경이므로 싱글톤 객체(스프링 빈, 서블릿)는 주의해서 사용해야함