# 웹 스코프

태그: 스프링

## 웹 스코프

- 웹 스코프는 웹 환경에서만 동작한다
- 웹 스코프는 프로토타입과 다르게 해당 스코프의 종료시점까지 관리한다. 따라서 종료 메서드가 호출된다
- 종류
    - request : HTTP 요청 하나가 들어오고 나갈 때 까지 유지되는 스코프, 각각의 HTTP 요청마다 별도의 인스턴스가 생성되고 관리된다
    - session : HTTP session과 동일한 생명주기를 가지는 스코프
    - application : 서블릿 컨텍스트와 동일한 생명주기를 가지는 스코프
    - websocket : 웹 소켓과 동일한 생명주기를 가지는 스코프
- request 스코프
    
    ![스크린샷 2023-01-12 오후 5.13.10.png](./%EC%9B%B9%20%EC%8A%A4%EC%BD%94%ED%94%84/requestscope.png)
    
    - 스프링 애플리케이션을 실행하는 시점에 싱글톤 빈은 생성해서 주입할 수 있지만, request 스코프 빈은 아직 생성되지 않는다
    - 이 빈은 실제 고객의 요청이 들어와야 생성할 수 있다
    - Provider
        - ObjectProvider를 사용하여 실제 요청이 들어오는 시점까지 request 스코프 빈의 생성을 지연할 수 있다.
        - ObjectProvider의 getObject()가 호출되는 시점에는 HTTP 요청이 진행중이므로 request 스코프 빈의 생성이 정상 처리된다
- 스코프와 프록시
    
    ```java
    @Component
    @Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
    public class MyLogger {
    }
    ```
    
    - 이렇게 하면 가짜 프록시 객체를 만들어두고 HTTP request와 상관 없이 가짜 프록시 클래스를 다른 빈에 미리 주입해 둘 수 있다
    - Provider를 쓰지 않고 일반적인 주입과 동일하게 코드를 작성한다
    - CGLIB라는 라이브러리로 내 클래스를 상속받은 가짜 프록시 객체를 만들어 주입한다
        - 스프링 컨테이너는 해당 라이브러리를 이용해서 가짜 프록시 객체를 만든다
        
        ![스크린샷 2023-01-12 오후 5.19.18.png](./%EC%9B%B9%20%EC%8A%A4%EC%BD%94%ED%94%84/di.png)
        
        - 가짜 프록시 객체는 요청이 오면 그때 내부에서 진짜 빈을 요청하는 위임 로직이 들어있다
        - 가짜 프록시 객체가 진짜 객체의 로직을 호출한다
        - 가짜 프록시 객체는 원본 클래스를 상속받아서 만들어졌기 때문에 클라이언트 입장에서는 원본인지 아닌지 알 수 없다 (다형성)
        - 싱글톤처럼 동작한다 (실제 싱글톤은 아니므로 주의해서 사용해야한다)